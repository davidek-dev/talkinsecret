---
// src/components/Music.astro
import MusicPlayer from '../components/MusicPlayer';
import '../styles/music-section.css'; // Importieren der neuen spezifischen CSS-Datei
import '../styles/debug.css'; // Debug CSS für Fortschrittsbalken und Debug-Anzeige
import '../styles/playlist-styles.css'; // Neue Styles für Playlist und Musikdienste

// Fetch playlist data (this will be server-side rendered)
let playlist = null;
let error = null;

try {
  // In der Entwicklungsumgebung müssen wir die Netlify Dev URL verwenden
  let baseUrl = '';
  
  if (import.meta.env.DEV) {
    // Im DEV-Modus nutzen wir direkt lokale Daten ohne Serveranfrage
    // Log entfernt für Production
    // Absichtlich abbrechen, um direkt zum Fallback-Daten zu springen
    throw new Error('LOCAL_DATA_DEV_MODE');
  }
  
  const response = await fetch(`${baseUrl}/.netlify/functions/get-playlist`);
  if (!response.ok) {
    // Error-Log entfernt für Production
    throw new Error('Failed to fetch playlist');
  }
  playlist = await response.json();
} catch (e) {
  // Prüfe, ob es sich um unseren lokalen Daten-Modus handelt
  if (e instanceof Error && e.message === 'LOCAL_DATA_DEV_MODE') {
    // Log entfernt für Production
  } else {
    // Error-Log entfernt für Production
    error = 'Unable to load playlist from API. Using local data instead.';
  }
  
  // Fallback playlist data for development with all tracks
  playlist = {
    albumTitle: "Petrichor",
    description: "Experience our latest album across all major streaming platforms.",
    songs: [
      {
        id: "petrichor-01",
        title: "Petrichor",
        artist: "Talkin'Secret",
        duration: "4:58",
        albumArt: "/images/image00001_scaled.webp",
        audioUrl: "/audio/petrichor/1 - Petrichor - Talkin'Secret Master 2 - 24_48.aac"
      },
      {
        id: "petrichor-02", 
        title: "Worth the Way",
        artist: "Talkin'Secret",
        duration: "4:16",
        albumArt: "/images/image00001_scaled.webp",
        audioUrl: "/audio/petrichor/2 - Worth the Way - Talkin'Secret Master 2 - 24_48.aac"
      },
      {
        id: "petrichor-03",
        title: "Come On",
        artist: "Talkin'Secret", 
        duration: "3:46",
        albumArt: "/images/image00001_scaled.webp",
        audioUrl: "/audio/petrichor/3 - Come On - Talkin'Secret Master 2 - 24_48.aac"
      },
      {
        id: "petrichor-04",
        title: "Changes", 
        artist: "Talkin'Secret",
        duration: "3:28",
        albumArt: "/images/image00001_scaled.webp",
        audioUrl: "/audio/petrichor/4 - Changes - Talkin'Secret Master 2 - 24_48.aac"
      },
      {
        id: "petrichor-05",
        title: "Stranger in Disguise",
        artist: "Talkin'Secret",
        duration: "3:44", 
        albumArt: "/images/image00001_scaled.webp",
        audioUrl: "/audio/petrichor/5 - Stranger in Disguise - Talkin'Secret Master 2 - 24_48.aac"
      },
      {
        id: "petrichor-06",
        title: "Glimpse of the Morning",
        artist: "Talkin'Secret",
        duration: "3:40", 
        albumArt: "/images/image00001_scaled.webp",
        audioUrl: "/audio/petrichor/6 - Glimpse of the Morning - Talkin'Secret Master 2 - 24_48.aac"
      },
      {
        id: "petrichor-07",
        title: "Miracles",
        artist: "Talkin'Secret",
        duration: "3:42", 
        albumArt: "/images/image00001_scaled.webp",
        audioUrl: "/audio/petrichor/7 - Miracles - Talkin'Secret Master 3 - 24_48.aac"
      },
      {
        id: "petrichor-08",
        title: "Only Friend",
        artist: "Talkin'Secret",
        duration: "4:52", 
        albumArt: "/images/image00001_scaled.webp",
        audioUrl: "/audio/petrichor/8 - Only Friend - Talkin'Secret Master 2 - 24_48.aac"
      },
      {
        id: "petrichor-09",
        title: "Somehow Somewhere",
        artist: "Talkin'Secret",
        duration: "6:06", 
        albumArt: "/images/image00001_scaled.webp",
        audioUrl: "/audio/petrichor/9 - Somehow Somewhere - Talkin'Secret Master 3 - 24_48.aac"
      }
    ]
  };
}
---

<section id="music" class="music-section" aria-labelledby="music-heading">
  <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-screen-2xl">
    <header class="pb-8 sm:pb-12 text-center text-white">
      <h2 id="music-heading" class="text-2xl sm:text-3xl lg:text-4xl font-bandfont">
        Petrichor
      </h2>
      <p class="text-base sm:text-lg lg:text-xl mt-2"> 
        Now available on all major streaming platforms!
      </p>
    </header>
    
    {error ? (
      <div class="error-message bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
        <p class="font-bold">Fehler beim Laden der Playlist</p>
        <p>{error}</p>
        <p class="mt-2">Sie können unsere Musik auch direkt auf Ihrer bevorzugten Streaming-Plattform anhören.</p>
      </div>
    ) : (
      <div class="music-container">
        <MusicPlayer 
          client:only="react"
          songs={playlist.songs}
          albumTitle={playlist.albumTitle}
          displayMusicServices={false}
        />
        <aside class="services-container mt-8 lg:mt-0" aria-labelledby="streaming-heading">
          <h3 id="streaming-heading" class="sr-only">Streaming-Plattformen</h3>
          <div class="music-services-flex">
            <style>
              /* Direkte Überschreibung für hohe Auflösungen */
              @media (min-width: 1800px) {
                .service-tile {
                  max-width: 140px !important;
                  padding: 1.2rem !important;
                  aspect-ratio: 1.5 !important;
                }
                
                .service-icon img {
                  max-width: 85px !important;
                  max-height: 58px !important;
                }
                
                .service-icon {
                  padding: 0.35rem !important;
                }
                
                .music-services-flex {
                  gap: 1.6rem !important;
                  max-width: 460px !important;
                  margin: 0 auto 1.6rem !important;
                  padding-bottom: 1.2rem !important;
                }
              }
            </style>
            <a 
              href="https://open.spotify.com/intl-de/album/2n3P39BKiFLF71iH1nmiv6" 
              class="service-tile focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 focus:ring-offset-black transition-all duration-200" 
              target="_blank" 
              rel="noopener noreferrer"
              aria-label="Album Petrichor auf Spotify anhören (öffnet neues Fenster)"
            >
              <span class="service-icon" aria-hidden="true">
                <img 
                  src="/images/Spotify_logo_with_text.svg" 
                  alt="" 
                  style="filter: brightness(0) invert(1);" 
                  loading="lazy"
                  width="80"
                  height="80"
                />
              </span>
            </a>
            
            <a 
              href="https://music.apple.com/de/album/petrichor/1789391867" 
              class="service-tile focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 focus:ring-offset-black transition-all duration-200" 
              target="_blank" 
              rel="noopener noreferrer"
              aria-label="Album Petrichor auf Apple Music anhören (öffnet neues Fenster)"
            >
              <span class="service-icon" aria-hidden="true">
                <img 
                  src="/images/Apple_Music_logo.svg" 
                  alt="" 
                  style="filter: brightness(0) invert(1);" 
                  loading="lazy"
                  width="80"
                  height="80"
                />
              </span>
            </a>
            
            <a 
              href="https://music.youtube.com/playlist?list=OLAK5uy_mwGChRREfOau5FJbcwTGlMN1qDTrt73B0" 
              class="service-tile focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-black transition-all duration-200" 
              target="_blank" 
              rel="noopener noreferrer"
              aria-label="Album Petrichor auf YouTube Music anhören (öffnet neues Fenster)"
            >
              <span class="service-icon" aria-hidden="true">
                <img 
                  src="/images/YT_Music.svg" 
                  alt="" 
                  style="filter: brightness(0) invert(1);" 
                  loading="lazy"
                  width="80"
                  height="80"
                />
              </span>
            </a>
            
            <a 
              href="https://music.amazon.de/albums/B0DSCK96HY" 
              class="service-tile focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-black transition-all duration-200" 
              target="_blank" 
              rel="noopener noreferrer"
              aria-label="Album Petrichor auf Amazon Music anhören (öffnet neues Fenster)"
            >
              <span class="service-icon" aria-hidden="true">
                <img 
                  src="/images/Amazon_Music_(Logo).svg" 
                  alt="" 
                  style="filter: brightness(0) invert(1);" 
                  loading="lazy"
                  width="80"
                  height="80"
                />
              </span>
            </a>
            
            <a 
              href="https://www.deezer.com/de/album/693504991" 
              class="service-tile focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-black transition-all duration-200" 
              target="_blank" 
              rel="noopener noreferrer"
              aria-label="Album Petrichor auf Deezer anhören (öffnet neues Fenster)"
            >
              <span class="service-icon" aria-hidden="true">
                <img 
                  src="/images/Deezer_logo,_2023.svg" 
                  alt="" 
                  style="filter: brightness(0) invert(1);" 
                  loading="lazy"
                  width="80"
                  height="80"
                />
              </span>
            </a>
          </div>
        </aside>
      </div>
    )}
  </div>
</section>